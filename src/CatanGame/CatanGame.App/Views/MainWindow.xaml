<Window x:Class="CatanGame.App.Views.MainWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
        xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
        xmlns:local="clr-namespace:CatanGame.App.Views"
        xmlns:vm="clr-namespace:CatanGame.App.ViewModels"
        xmlns:converters="clr-namespace:CatanGame.App.Converters"
        mc:Ignorable="d"
        Title="カタン" Height="800" Width="1200">
    <Window.Resources>
        <converters:StringToVisibilityConverter x:Key="StringToVisibilityConverter"/>
    </Window.Resources>
    <Window.DataContext>
        <vm:MainViewModel />
    </Window.DataContext>

    <Grid>
        <Grid.ColumnDefinitions>
            <ColumnDefinition Width="*"/>
            <ColumnDefinition Width="250"/>
        </Grid.ColumnDefinitions>

        <Border Grid.Column="0" Background="#87CEEB" Padding="10">
            <ScrollViewer HorizontalScrollBarVisibility="Auto" VerticalScrollBarVisibility="Auto">
                <Canvas Width="800" Height="700" Background="Transparent">
                    <!-- タイルの描画 -->
                    <ItemsControl ItemsSource="{Binding HexTiles}">
                        <ItemsControl.ItemsPanel>
                            <ItemsPanelTemplate>
                                <Canvas/>
                            </ItemsPanelTemplate>
                        </ItemsControl.ItemsPanel>
                        <ItemsControl.ItemContainerStyle>
                            <Style>
                                <Setter Property="Canvas.Left" Value="{Binding Center.X}"/>
                                <Setter Property="Canvas.Top" Value="{Binding Center.Y}"/>
                            </Style>
                        </ItemsControl.ItemContainerStyle>
                        <ItemsControl.ItemTemplate>
                            <DataTemplate>
                                <local:HexagonControl DataContext="{Binding}"/>
                            </DataTemplate>
                        </ItemsControl.ItemTemplate>
                    </ItemsControl>

                    <!-- 港の描画 -->
                    <ItemsControl ItemsSource="{Binding Ports}">
                        <ItemsControl.ItemsPanel>
                            <ItemsPanelTemplate>
                                <Canvas/>
                            </ItemsPanelTemplate>
                        </ItemsControl.ItemsPanel>
                        <ItemsControl.ItemContainerStyle>
                            <Style>
                                <Setter Property="Canvas.Left" Value="{Binding Position.X}"/>
                                <Setter Property="Canvas.Top" Value="{Binding Position.Y}"/>
                            </Style>
                        </ItemsControl.ItemContainerStyle>
                        <ItemsControl.ItemTemplate>
                            <DataTemplate>
                                <Border Width="50" Height="24"
                                        Background="{Binding BackgroundColor}"
                                        BorderBrush="Black"
                                        BorderThickness="2"
                                        CornerRadius="3"
                                        RenderTransformOrigin="0.5,0.5">
                                    <Border.RenderTransform>
                                        <RotateTransform Angle="{Binding Rotation}"/>
                                    </Border.RenderTransform>
                                    <TextBlock Text="{Binding DisplayText}"
                                               FontSize="13"
                                               FontWeight="Bold"
                                               Foreground="White"
                                               TextAlignment="Center"
                                               VerticalAlignment="Center"
                                               HorizontalAlignment="Center"/>
                                </Border>
                            </DataTemplate>
                        </ItemsControl.ItemTemplate>
                    </ItemsControl>

                    <!-- 道路の描画 -->
                    <ItemsControl ItemsSource="{Binding Edges}">
                        <ItemsControl.ItemsPanel>
                            <ItemsPanelTemplate>
                                <Canvas/>
                            </ItemsPanelTemplate>
                        </ItemsControl.ItemsPanel>
                        <ItemsControl.ItemTemplate>
                            <DataTemplate>
                                <Line X1="{Binding StartPoint.X}" Y1="{Binding StartPoint.Y}"
                                      X2="{Binding EndPoint.X}" Y2="{Binding EndPoint.Y}"
                                      Stroke="{Binding RoadColor}"
                                      StrokeThickness="5"
                                      Cursor="Hand">
                                    <Line.Style>
                                        <Style TargetType="Line">
                                            <Style.Triggers>
                                                <DataTrigger Binding="{Binding HasRoad}" Value="False">
                                                    <Setter Property="Visibility" Value="Collapsed"/>
                                                </DataTrigger>
                                            </Style.Triggers>
                                        </Style>
                                    </Line.Style>
                                </Line>
                            </DataTemplate>
                        </ItemsControl.ItemTemplate>
                    </ItemsControl>

                    <!-- クリック可能な辺（道路配置用） -->
                    <ItemsControl ItemsSource="{Binding Edges}">
                        <ItemsControl.ItemsPanel>
                            <ItemsPanelTemplate>
                                <Canvas/>
                            </ItemsPanelTemplate>
                        </ItemsControl.ItemsPanel>
                        <ItemsControl.ItemTemplate>
                            <DataTemplate>
                                <Line X1="{Binding StartPoint.X}" Y1="{Binding StartPoint.Y}"
                                      X2="{Binding EndPoint.X}" Y2="{Binding EndPoint.Y}"
                                      Stroke="#80FF00FF"
                                      StrokeThickness="6"
                                      Cursor="Hand">
                                    <Line.InputBindings>
                                        <MouseBinding Command="{Binding DataContext.EdgeClickCommand, RelativeSource={RelativeSource AncestorType=Window}}"
                                                      CommandParameter="{Binding}"
                                                      MouseAction="LeftClick"/>
                                    </Line.InputBindings>
                                    <Line.Style>
                                        <Style TargetType="Line">
                                            <Style.Triggers>
                                                <DataTrigger Binding="{Binding IsClickable}" Value="False">
                                                    <Setter Property="Visibility" Value="Collapsed"/>
                                                </DataTrigger>
                                            </Style.Triggers>
                                        </Style>
                                    </Line.Style>
                                </Line>
                            </DataTemplate>
                        </ItemsControl.ItemTemplate>
                    </ItemsControl>

                    <!-- 開拓地・都市の描画 -->
                    <ItemsControl ItemsSource="{Binding Vertices}">
                        <ItemsControl.ItemsPanel>
                            <ItemsPanelTemplate>
                                <Canvas/>
                            </ItemsPanelTemplate>
                        </ItemsControl.ItemsPanel>
                        <ItemsControl.ItemContainerStyle>
                            <Style>
                                <Setter Property="Canvas.Left" Value="{Binding Center.X}"/>
                                <Setter Property="Canvas.Top" Value="{Binding Center.Y}"/>
                            </Style>
                        </ItemsControl.ItemContainerStyle>
                        <ItemsControl.ItemTemplate>
                            <DataTemplate>
                                <Grid>
                                    <!-- 開拓地（家の形） -->
                                    <Path Fill="{Binding SettlementColor}"
                                          Stroke="Black"
                                          StrokeThickness="1.5"
                                          Data="M 0,-8 L -6,0 L -6,6 L 6,6 L 6,0 Z">
                                        <Path.Style>
                                            <Style TargetType="Path">
                                                <Style.Triggers>
                                                    <DataTrigger Binding="{Binding HasSettlement}" Value="False">
                                                        <Setter Property="Visibility" Value="Collapsed"/>
                                                    </DataTrigger>
                                                    <DataTrigger Binding="{Binding IsCity}" Value="True">
                                                        <Setter Property="Visibility" Value="Collapsed"/>
                                                    </DataTrigger>
                                                </Style.Triggers>
                                            </Style>
                                        </Path.Style>
                                    </Path>

                                    <!-- 都市（城の形） -->
                                    <Path Fill="{Binding SettlementColor}"
                                          Stroke="Black"
                                          StrokeThickness="1.5"
                                          Data="M -8,-8 L -8,6 L 8,6 L 8,-8 L 6,-8 L 6,-6 L 4,-6 L 4,-8 L 0,-8 L 0,-6 L -2,-6 L -2,-8 Z">
                                        <Path.Style>
                                            <Style TargetType="Path">
                                                <Style.Triggers>
                                                    <MultiDataTrigger>
                                                        <MultiDataTrigger.Conditions>
                                                            <Condition Binding="{Binding HasSettlement}" Value="True"/>
                                                            <Condition Binding="{Binding IsCity}" Value="True"/>
                                                        </MultiDataTrigger.Conditions>
                                                        <Setter Property="Visibility" Value="Visible"/>
                                                    </MultiDataTrigger>
                                                    <MultiDataTrigger>
                                                        <MultiDataTrigger.Conditions>
                                                            <Condition Binding="{Binding HasSettlement}" Value="False"/>
                                                        </MultiDataTrigger.Conditions>
                                                        <Setter Property="Visibility" Value="Collapsed"/>
                                                    </MultiDataTrigger>
                                                    <MultiDataTrigger>
                                                        <MultiDataTrigger.Conditions>
                                                            <Condition Binding="{Binding IsCity}" Value="False"/>
                                                        </MultiDataTrigger.Conditions>
                                                        <Setter Property="Visibility" Value="Collapsed"/>
                                                    </MultiDataTrigger>
                                                </Style.Triggers>
                                            </Style>
                                        </Path.Style>
                                    </Path>
                                </Grid>
                            </DataTemplate>
                        </ItemsControl.ItemTemplate>
                    </ItemsControl>

                    <!-- クリック可能な頂点（開拓地配置用） -->
                    <ItemsControl ItemsSource="{Binding Vertices}">
                        <ItemsControl.ItemsPanel>
                            <ItemsPanelTemplate>
                                <Canvas/>
                            </ItemsPanelTemplate>
                        </ItemsControl.ItemsPanel>
                        <ItemsControl.ItemContainerStyle>
                            <Style>
                                <Setter Property="Canvas.Left" Value="{Binding Center.X}"/>
                                <Setter Property="Canvas.Top" Value="{Binding Center.Y}"/>
                            </Style>
                        </ItemsControl.ItemContainerStyle>
                        <ItemsControl.ItemTemplate>
                            <DataTemplate>
                                <Ellipse Width="16" Height="16"
                                         Fill="#8000FF00"
                                         Stroke="#00FF00"
                                         StrokeThickness="2"
                                         Cursor="Hand"
                                         RenderTransformOrigin="0.5,0.5">
                                    <Ellipse.RenderTransform>
                                        <TranslateTransform X="-8" Y="-8"/>
                                    </Ellipse.RenderTransform>
                                    <Ellipse.InputBindings>
                                        <MouseBinding Command="{Binding DataContext.VertexClickCommand, RelativeSource={RelativeSource AncestorType=Window}}"
                                                      CommandParameter="{Binding}"
                                                      MouseAction="LeftClick"/>
                                    </Ellipse.InputBindings>
                                    <Ellipse.Style>
                                        <Style TargetType="Ellipse">
                                            <Style.Triggers>
                                                <DataTrigger Binding="{Binding IsClickable}" Value="False">
                                                    <Setter Property="Visibility" Value="Collapsed"/>
                                                </DataTrigger>
                                            </Style.Triggers>
                                        </Style>
                                    </Ellipse.Style>
                                </Ellipse>
                            </DataTemplate>
                        </ItemsControl.ItemTemplate>
                    </ItemsControl>
                </Canvas>
            </ScrollViewer>
        </Border>

        <Border Grid.Column="1" Background="#F0F0F0" BorderBrush="#CCCCCC" BorderThickness="1,0,0,0">
            <StackPanel Margin="10">
                <TextBlock Text="カタン" FontSize="24" FontWeight="Bold" Margin="0,0,0,20"/>

                <Button Content="新規ゲーム"
                        Command="{Binding NewGameCommand}"
                        Padding="10,5"
                        Margin="0,0,0,10"
                        FontSize="14"/>

                <Separator Margin="0,10"/>

                <TextBlock Text="現在のプレイヤー:" FontSize="14" FontWeight="Bold" Margin="0,10,0,5"/>
                <TextBlock Text="{Binding CurrentPlayerName}" FontSize="16" Margin="0,0,0,10"/>

                <Separator Margin="0,10"/>

                <TextBlock Text="初期配置フェーズ:" FontSize="14" FontWeight="Bold" Margin="0,10,0,5"/>
                <TextBlock Text="{Binding SetupPhaseMessage}"
                           FontSize="13"
                           Foreground="#0066CC"
                           TextWrapping="Wrap"
                           Margin="0,0,0,10"/>

                <Separator Margin="0,10"/>

                <Button Content="サイコロを振る"
                        Command="{Binding RollDiceCommand}"
                        Padding="10,5"
                        Margin="0,0,0,10"
                        FontSize="14"/>

                <TextBlock Text="サイコロの目:" FontSize="14" FontWeight="Bold" Margin="0,10,0,5"/>
                <TextBlock Text="{Binding DiceRoll}" FontSize="32" HorizontalAlignment="Center" Margin="0,0,0,10"/>

                <Separator Margin="0,10"/>

                <TextBlock Text="ゲーム進行" FontSize="14" FontWeight="Bold" Margin="0,10,0,10"/>
                <TextBlock Text="フェーズ2: 初期配置" TextWrapping="Wrap" Margin="0,0,0,5"/>
                <TextBlock Text="• 各プレイヤー2つの開拓地と道路を配置" TextWrapping="Wrap" Margin="10,0,0,5" FontSize="12"/>
                <TextBlock Text="• 2巡目の開拓地から初期資源を取得" TextWrapping="Wrap" Margin="10,0,0,5" FontSize="12"/>
            </StackPanel>
        </Border>
    </Grid>
</Window>
